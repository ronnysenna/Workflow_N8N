{"createdAt":"2025-03-19T00:14:34.366Z","updatedAt":"2025-03-31T13:52:54.000Z","id":"rTBALCGYk5UJlDj5","name":"NOVO ATENDIMENTO","active":true,"nodes":[{"parameters":{"assignments":{"assignments":[{"id":"7066ff08-1370-464f-a588-86aa37025523","name":"texto","value":"={{ $json.text }}","type":"string"}]},"options":{}},"id":"8e06797f-0950-47a1-b41b-dcd3a46f576f","name":"edit1","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[240,500],"alwaysOutputData":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"17b6fa1c-f4ea-4c75-9c9e-1a43900dbc58","leftValue":"={{ $json.api_key }}","rightValue":"={{ $json.body.apikey }}\n\n","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"id":"0b57639b-3f3a-4e5d-a1db-1974a5ac2bcf","name":"auth","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-640,600]},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.body.data.messageType }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"audio"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"50c6e2b0-2494-4780-abd8-84a0e4213091","leftValue":"={{ $json.body.data.messageType }}","rightValue":"conversation","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"texto"}]},"options":{"fallbackOutput":"extra"}},"id":"8b9fd003-05e5-487a-a71a-8108593be7c5","name":"mensagem_tipo","type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-420,600],"alwaysOutputData":false},{"parameters":{"httpMethod":"POST","path":"agente","options":{}},"id":"78a844d8-2cc0-4f9b-b612-64d759da5ac3","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1080,600],"webhookId":"212f556b-9bb1-4dbc-be3c-98af97a04e07"},{"parameters":{"assignments":{"assignments":[{"id":"2f8e1fbf-9134-4b48-be29-066509e021f5","name":"telefone","value":"={{ $('Webhook').item.json.body.data.key.remoteJid }}","type":"string"},{"id":"60d6b895-fea6-4d7f-932a-b8771c97242e","name":"WhatsAppApp","value":"={{ $json.mensagem_tipo?.body?.data?.message?.conversation || $json.texto || '' }}\n\n","type":"string"},{"id":"e7b1afb0-6fc0-4098-ba3d-3bbacc2fe831","name":"pushName","value":"={{ $('auth').item.json.body.data.pushName }}","type":"string"}]},"options":{}},"id":"6c5f06bb-4add-41a5-97b6-3118ea3fcb1d","name":"Filtra Webhook","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[460,600]},{"parameters":{"operation":"toBinary","sourceProperty":"body.data.message.base64","options":{"fileName":"file.ogg","mimeType":"={{ $json.body.data.message.audioMessage.mimetype }}"}},"id":"f5d859f3-3bae-42fd-873a-1fdf68b0d050","name":"Convert audio","type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[-200,500],"alwaysOutputData":true},{"parameters":{"resource":"audio","operation":"transcribe","options":{}},"id":"61c82c33-a999-4c93-bdd8-5dd5c44c249d","name":"Transcreve Audio","type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.6,"position":[20,500],"credentials":{"openAiApi":{"id":"V3SIs1GbnDJ4HJfO","name":"OpenAi"}}},{"parameters":{"assignments":{"assignments":[{"id":"09db48f1-b99e-4760-8a9b-10944a1ce0d2","name":"texto","value":"={{ $json.body.data.message.conversation }}","type":"string"}]},"options":{}},"id":"d501288b-0269-463d-a725-c3589430eb53","name":"Pega a mensagem","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[240,700]},{"parameters":{"operation":"executeQuery","query":"CREATE TABLE historico_atendimento (\n  id SERIAL PRIMARY KEY,\n  telefone VARCHAR(50),\n  mensagem TEXT,\n  origem VARCHAR(50),\n  data TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-1160,-300],"id":"a4d50669-384a-4925-8002-f7d75d5378c1","name":"Postgres","credentials":{"postgres":{"id":"7a2Vz2gtRVeYNBS4","name":"Postgres"}}},{"parameters":{"operation":"executeQuery","query":"INSERT INTO historico_atendimento (telefone, mensagem, origem)\nVALUES ('{{$json.telefone}}', '{{$json.WhatsAppApp}}', 'Whatsapp');\n\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[680,600],"id":"98fbda23-f160-4705-9e84-bbf7fb49fa5b","name":"Insert_banco","credentials":{"postgres":{"id":"7a2Vz2gtRVeYNBS4","name":"Postgres"}}},{"parameters":{"operation":"executeQuery","query":"TRUNCATE TABLE historico_atendimento;\n\n","options":{}},"type":"n8n-nodes-base.postgres","typeVersion":2.5,"position":[-1160,-520],"id":"1989027f-ba5a-4e49-906a-46e75793e3ba","name":"Insert_banco1","credentials":{"postgres":{"id":"7a2Vz2gtRVeYNBS4","name":"Postgres"}}},{"parameters":{"promptType":"define","text":"={{ $('Filtra Webhook').item.json.WhatsAppApp }}","options":{"systemMessage":"=Você é o agente virtual da empresa Ideal Rastreamento, especialista em rastreamento veicular.\n\nResponda sempre de forma cordial, objetiva e siga EXATAMENTE esse fluxo:\n\n1. Cumprimente o cliente;\n2. Pergunte se ele é CLIENTE da Ideal Rastreamento;\n3. Espere a resposta:\n   - Se for CLIENTE:\n      - Parabenize o cliente por fazer parte da Ideal Rastreamento;\n      - Peça o NOME;\n      - Comece a chamalo pelo nome;\n      - Pergunte em que pode ajuda:\n\n      - Classifique a intenção:\n        Sinistro\n        Financeiro\n        Suporte\n        \n\n   - Se NÃO for cliente:\n      - NÃO faça mais perguntas técnicas;\n      - Ofereça os serviços da Ideal Rastreamento;\n      - Encaminhe para o setor COMERCIAL;\n      - Finalize com:\n        \"Pelo que entendi, vou te direcionar para o setor de: Comercial\"\n\nOBS:\nQuando o cliente responder \"não\", \"não sou cliente\", \"não sou\", \"não sou da Ideal\", ou qualquer resposta negativa, entenda que ele NÃO É CLIENTE.\n\nNestes casos, NUNCA continue perguntando sobre problemas técnicos ou rastreadores.\n\nApenas ofereça os serviços da Ideal Rastreamento e finalize com:\n\"Pelo que entendi, vou te direcionar para o setor de: Comercial\"\n\n⚠️ Jamais misture o atendimento técnico com o comercial.\n⚠️ Caso não seja cliente, NÃO faça perguntas sobre problemas técnicos ou o rastreador.\n\n⚠️ IMPORTANTE:\nNunca direcione o cliente para um setor antes de perguntar o nome e a intenção dele.\nSe o cliente disser que é cliente, pergunte o nome e qual a área que deseja atendimento: Suporte, Financeiro ou Sinistro.\n\n\n---\n\n🧠 *Agora, use o histórico da conversa abaixo (se houver) como contexto para sua resposta:*\n\n{{ (() => {\n  const memoria = JSON.parse($('Redis GET').item.json.session_key || '{}');\n  const historico = memoria.respostas ? memoria.respostas.join('\\n') : 'Sem histórico anterior.';\n  return `Histórico:\\n${historico}`;\n})() }}\n\n📨 Mensagem recebida:\n{{ $('Filtra Webhook').item.json.WhatsAppApp }}\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[1560,600],"id":"ee889c1b-c5b4-403f-bae3-2e705f77e198","name":"AI Agent"},{"parameters":{"resource":"messages-api","instanceName":"rastreamento","remoteJid":"={{ $('Filtra Webhook').item.json.telefone }}","messageText":"={{ $json.raw_output }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2600,480],"id":"82c2138f-7b09-4b3b-80dc-59bf9f35a546","name":"Evolution API1","credentials":{"evolutionApi":{"id":"FK5HLtfwZybZ0Kyw","name":"Evolution "}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"Comercial","rightValue":"={{ $json.intencao }}","operator":{"type":"string","operation":"equals"},"id":"34333b8a-e929-4e0a-b614-f13db6002d20"}],"combinator":"and"},"renameOutput":true,"outputKey":"Comercial"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8bcb5efa-54ce-4954-95ac-009c5e50658e","leftValue":"Sinistro","rightValue":"={{ $json.intencao }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Sinistro"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3626b364-3e9b-4177-b9c3-95799fa71ef9","leftValue":"Suporte","rightValue":"={{ $json.intencao }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Suporte"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"dab17723-c369-4524-a869-da7e0a701caa","leftValue":"Financeiro","rightValue":"={{ $json.intencao }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Financeiro"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"39a8c482-8df2-4245-a833-7b941767976d","leftValue":"Triagem","rightValue":"={{ $json.intencao }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Triagem"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[2596,758],"id":"f22d566e-6a2a-421a-98cf-42b8c768cd17","name":"Switch"},{"parameters":{"jsCode":"const results = [];\n\nfor (const item of items) {\n  const output = item.json.output || '';\n\n  // Ignora as mensagens de consulta do próprio AI\n  if (output.includes('em que posso te ajudar') || output.includes('Você precisa de atendimento')) {\n    results.push({\n      json: {\n        intencao: 'Triagem',\n        raw_output: output,\n        agente: 'agent'\n      }\n    });\n    continue;\n  }\n\n  const intencaoMatch = output.match(/Comercial|Suporte|Financeiro|Sinistro/);\n  const intencao = intencaoMatch ? intencaoMatch[0] : null;\n  const isCliente = /sou cliente|sim\\b/i.test(output);\n\n  let agente = 'agent'; // Default na triagem\n\n  if (intencao) {\n    agente = intencao;\n  } else if (isCliente) {\n    agente = 'agent'; // Ainda na triagem aguardando intenção\n  }\n\n  results.push({\n    json: {\n      intencao: intencao || 'Triagem',\n      raw_output: output,\n      agente\n    }\n  });\n}\n\nreturn results;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2156,600],"id":"79db121d-f18e-49cb-b82f-f397c0f296c3","name":"Code"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7f0902ab-2009-46ee-b8ad-b3f99fd22cd2","leftValue":"={{ $json.intencao }}","rightValue":"=Triagem","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"df485a65-e208-46a5-858c-853299cea76f","leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2376,600],"id":"1cba4b11-485c-47ef-a337-f923a7e8a8cf","name":"If"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Filtra Webhook').item.json.telefone }}","contextWindowLength":20},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.4,"position":[1708,820],"id":"bbcba451-8cce-4376-a151-b4850c537a93","name":"Redis","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"resource":"messages-api","instanceName":"rastreamento","remoteJid":"={{ $('Filtra Webhook').item.json.telefone }}","messageText":"={{ $json.output }}","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[4080,900],"id":"4a939438-129f-49d3-897e-aa57e8bd4178","name":"Evolution API","credentials":{"evolutionApi":{"id":"FK5HLtfwZybZ0Kyw","name":"Evolution "}}},{"parameters":{"promptType":"define","text":"={{ $json.raw_output }}","options":{"systemMessage":"=Você é o atendente virtual do setor FINANCEIRO da Ideal Rastreamento.\n\n✅ Sua missão:\n- Cumprimente o cliente de forma educada e cordial;\n- Informe que está no setor FINANCEIRO;\n- Solicite o NOME ou CPF/CNPJ do titular da conta;\n- Entenda qual é a demanda financeira do cliente;\n- Responda somente sobre boletos, pagamentos ou pendências financeiras;\n⚠️ Nunca responda sobre assuntos de Suporte, Comercial ou Sinistro.\n\n📌 Se o cliente pedir a SEGUNDA VIA DO BOLETO ou PIX, responda:\n\"Perfeito! Vou gerar a sua segunda via agora mesmo. Em instantes, você receberá o boleto atualizado ou o PIX para pagamento, tudo certinho aqui pelo WhatsApp. 😃\"\n\n📌 Outras dúvidas financeiras:\nSe o cliente perguntar sobre valores, vencimento ou pagamentos:\n\"Certo! Qual valor ou vencimento você deseja confirmar?\"\n\n✅ Finalize sempre com:\n\"Estou à disposição para qualquer outra dúvida financeira. 😊\"\n\n⚠️ Atenção: Nunca adicione `{ \"acao\": \"...\" }` dentro da resposta ao cliente.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[3036,1500],"id":"4fcc3c4c-46bb-4ee7-84c3-6963bf08afd1","name":"AI Financeiro"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Filtra Webhook').item.json.telefone }}","contextWindowLength":50},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.4,"position":[3184,1720],"id":"e3086f31-9f35-4300-b525-763aa3762a50","name":"Redis1","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Filtra Webhook').item.json.telefone }}","contextWindowLength":50},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.4,"position":[3780,320],"id":"052e2003-bfa0-4947-b35a-1e696899d1e0","name":"Redis2","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Filtra Webhook').item.json.telefone }}","contextWindowLength":50},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.4,"position":[3780,720],"id":"cf881479-b942-4d24-9637-d2e89be895c2","name":"Redis3","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"promptType":"define","text":"={{ $json.raw_output }}","options":{"systemMessage":"=Você é o atendente virtual do setor de SINISTRO da Ideal Rastreamento.\n\n✅ Sua missão: Cumprimente o cliente de forma cordial; Reforce que está no atendimento exclusivo de SINISTRO; Solicite o NOME do titular ou CPF/CNPJ da conta; Entenda o ocorrido e colete o máximo de informações sobre o sinistro; Oriente o cliente sempre que for caso de roubo, furto ; ⚠️ Jamais fale sobre planos, financeiro ou suporte técnico.\n\n📋 Perguntas obrigatórias para o registro do sinistro:\n\nQual a data e horário do ocorrido?\n\nQual o local aproximado do roubo ou furto?\n\nO veículo já possui boletim de ocorrência registrado?\n\nQual a placa do veículo?\n\nO veículo está com bloqueio ativo ou ainda em movimento?\n\n🚨 Orientação de URGÊNCIA (sempre que o cliente relatar um sinistro): Reforce: Mantenha a calma! 🛑 Faça imediatamente o procedimento básico de segurança:\n\n🔒 Acione o bloqueio do veículo pelo aplicativo ou diretamente conosco; ☎️ Ligue para a nossa Central de Urgência:\n\n(85) 99190-4540\n\n(85) 99252-5311\n\n📝 Registre o Boletim de Ocorrência (B.O.) o quanto antes.\n\n✅ Resposta padrão após coleta das informações: Obrigado pelas informações!\nNosso time de monitoramento será acionado IMEDIATAMENTE para dar suporte na localização do veículo.\nSeguimos acompanhando seu caso de perto.\n\n🎯 Se o cliente perguntar como agir em caso de sinistro (sem ter ocorrido ainda): Explique: Em caso de roubo ou furto, é essencial:\n\nAcionar o bloqueio do veículo;\n\nLigar para nossa Central de Urgência;\n\nRegistrar o Boletim de Ocorrência;\n\nNos informar o mais rápido possível para iniciarmos a busca.\n\n🟢 Encerramento padrão: Qualquer outra dúvida ou necessidade, estou à disposição!\nVamos te ajudar da melhor forma possível.\n\n⚠️ Lembretes finais do AI:\n\nNunca trate financeiro, planos ou suporte técnico;\n\nFoque 100% em sinistro e emergências;\n\nSempre oriente o cliente a agir rapidamente para aumentar as chances de recuperação do veículo.\n\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[3632,500],"id":"e9dcdfc1-fba5-44bc-ae76-503aee41a880","name":"AI Sinistro"},{"parameters":{"promptType":"define","text":"={{ $json.raw_output }}","options":{"systemMessage":"=Você é o agente virtual da empresa **Ideal Rastreamento**, especializado no atendimento comercial.\n\n✅ Sua missão:\n- Cumprimente de forma simpática;\n- Confirme o nome da pessoa;\n- Descubra o interesse da pessoa;\n- Explique brevemente quem somos;\n- Apresente as vantagens do serviço;\n- Só depois, ofereça os planos e o link;\n- Finalize deixando o canal aberto para dúvidas.\n\n⚠️ Evite textão ou repetir que a pessoa não é cliente.\n⚠️ Nada de empurrar valor sem o cliente pedir.\n\n---\n\n**Exemplo de atendimento curto:**\n\nOlá! Que bom ter você aqui 😄  \nPosso te chamar de como?\n\nNós somos da **Ideal Rastreamento**, especialista em proteger seu veículo com tecnologia de rastreamento.\n\nNosso serviço permite acompanhar seu carro pelo app e acionar bloqueio remoto se precisar.\n\nQuer conhecer nossos planos?\n\n---\n\n**Planos disponíveis:**\n\n🚗 **Plano 1** - R$ 54,90/mês + Instalação R$60\n- Rastreamento pelo app\n- Bloqueio remoto\n- Relatórios e notificações\n- Cobertura nacional\n- Sem consulta SPC/Serasa\n- Sem fidelidade\n\n🚗 **Plano 2** - R$ 74,90/mês + Instalação R$60\n- Tudo do Plano 1\n- ✅ Assistência 24h (guincho, pane seca, chaveiro...)\n\n👉 Link para contratar: **https://idealrastreamento.com/forms/**\n\nMe fala se quer seguir ou tirar alguma dúvida 😊\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[3632,100],"id":"bb6d65a9-5753-49c0-8207-742728a30a42","name":"AI Comercial"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Filtra Webhook').item.json.telefone }}","contextWindowLength":50},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.4,"position":[3780,1120],"id":"fc609d4e-c35e-498f-b6fc-911974fe6d22","name":"Redis4","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"operation":"set","key":"=session_{{ $('Filtra Webhook').item.json.telefone }}","value":"={{ $json.output }}\n"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1936,600],"id":"eaa16325-c112-4592-aac3-4b5ab910305d","name":"Redis SET","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"operation":"get","propertyName":"session_key","key":"=session_ {{ $('Filtra Webhook').item.json.telefone }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[1120,600],"id":"66ff8b02-673a-4dcb-a914-4b14797f8619","name":"Redis GET","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"jsCode":"const session = JSON.parse($json.session_key || '{}');\n\n// Debug no execution log do n8n\nconsole.log('🟢 Conteúdo da sessão:', session);\nconsole.log('🟠 Histórico de respostas:', session.respostas);\nconsole.log('🔵 Agente:', session.agente);\n\n// Retorno para seguir o fluxo\nreturn [{\n  json: {\n    respostas: session.respostas || [],\n    agente: session.agente || 'agent'\n  }\n}];\n\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1340,600],"id":"ae87dcbb-c5f6-40a6-9d66-073a4f1d4699","name":"Code1"},{"parameters":{"operation":"set","key":"=agent_session_{{ $('Filtra Webhook').item.json.telefone }}","value":"Comercial"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3412,200],"id":"1a10af1b-c6b8-45e1-91b4-f3ddfd325195","name":"Redis5","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"operation":"set","key":"=agent_session_{{ $('Filtra Webhook').item.json.telefone }}","value":"Sinistro"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3412,600],"id":"a60c7d89-551a-4bb3-9e90-fde2566e460e","name":"Redis6","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"operation":"set","key":"=agent_session_{{ $('Filtra Webhook').item.json.telefone }}","value":"Financeiro"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[2816,1500],"id":"96d6860f-eaf6-4a9a-b734-86045bd9ee53","name":"Redis7","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"operation":"set","key":"=agent_session_{{ $('Filtra Webhook').item.json.telefone }}","value":"Suporte"},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[3412,1000],"id":"b600db3a-d605-4a67-83ed-ee60f916df27","name":"Redis8","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"promptType":"define","text":"={{ $json.raw_output }}","options":{"systemMessage":"=Você é o atendente virtual do SUPORTE da Ideal Rastreamento.\n\n✅ **Função principal**:\n- Cumprimente o cliente;\n- Peça o **NOME do titular ou CPF/CNPJ** da conta;\n- Descubra o problema técnico;\n- **NUNCA** fale de **planos, vendas ou financeiro**;\n- **NUNCA** transfira ou direcione para o setor, há não ser que o cliente peça para mudar de setor;\n- Sempre resolva dentro do SUPORTE.\n\n---\n\n⚠️ Sempre que o cliente disser algo como:\n- \"não tenho app\"\n- \"quero instalar o aplicativo\"\n- \"não consigo acessar\"\n- \"perdi o app\"\n- \"problema no login\"\n\n✅ RESPONDA IMEDIATAMENTE com o texto abaixo:\n\n> Para ter acesso ao aplicativo, segue os links oficiais:\n> - *PC:* http://ideal.rastrosystem.com.br/acl/login/?next=/\n> - *iPhone:* https://apps.apple.com/br/app/rastro-system-3-0/id6474566461\n> - *Android:* https://play.google.com/store/apps/details?id=com.rastrosystem.v3\n\nE pergunte se o cliente precisa de mais alguma ajuda.\n\n---\n\n⚠️ **Se o problema for o rastreador ou equipamento sem comunicação**, responda:\n> Vamos enviar os comandos necessários para atualizar seu equipamento. ⚙️  \n> Esse processo pode levar **de 6 a 12 horas** para validar e o equipamento voltar a comunicar normalmente.  \n> Caso não volte após esse prazo, fale novamente conosco, combinado?\n\n---\n\n✅ **IMPORTANTE**:\n- NUNCA transfira o atendimento para o Comercial ou outro setor.\n- Mesmo que o cliente diga \"não tenho o app\" ou \"quero instalar\", **trate no SUPORTE** e **envie os links**.\n- Se o cliente mencionar valores, planos ou pagamento, educadamente diga: \n> \"Posso te ajudar apenas com o suporte técnico. Para informações sobre planos e valores, entre em contato com nosso setor comercial.\"\n\n---\n\n✅ **Finalização padrão**:\n> Vou te ajudar a resolver o mais rápido possível.\n\nSempre responda de forma **clara, educada e objetiva**.\n"}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[3632,900],"id":"1d18211c-7720-4132-9011-3b27d155f668","name":"AI Suporte"},{"parameters":{"operation":"get","propertyName":"agente_key","key":"=agent_session_{{ $('Filtra Webhook').item.json.telefone }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[900,600],"id":"aa13b86a-6256-4d8d-b72d-edb6ed1304ad","name":"Redis9","credentials":{"redis":{"id":"0bFvtbsVkTSFKWIy","name":"Redis"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4o-mini"},"options":{"temperature":0.7}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1588,820],"id":"a5d7f82a-7818-4aeb-bac4-ae2f7ded46b6","name":"OpenAI","credentials":{"openAiApi":{"id":"V3SIs1GbnDJ4HJfO","name":"OpenAi"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[3660,720],"id":"d31af6c7-2307-4732-83a3-370a187f9bcd","name":"OpenAI1","credentials":{"openAiApi":{"id":"V3SIs1GbnDJ4HJfO","name":"OpenAi"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[3660,1120],"id":"c1507686-5f09-47e3-845d-a46e540bf1f3","name":"OpenAI2","credentials":{"openAiApi":{"id":"V3SIs1GbnDJ4HJfO","name":"OpenAi"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[3660,320],"id":"9a266f09-1444-4645-8c55-37357ff05c89","name":"OpenAI3","credentials":{"openAiApi":{"id":"V3SIs1GbnDJ4HJfO","name":"OpenAi"}}},{"parameters":{"model":{"__rl":true,"mode":"list","value":"gpt-4o-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[3060,1720],"id":"9a3e4617-d288-4272-849d-4e259ccecca6","name":"OpenAI4","credentials":{"openAiApi":{"id":"V3SIs1GbnDJ4HJfO","name":"OpenAi"}}},{"parameters":{"jsCode":"const results = [];\n\nfor (const item of items) {\n  const msg = (item.json.output || '').toLowerCase();\n\n  const frasesSegundaVia = [\n    'segunda via',\n    'me manda o boleto',\n    'quero pagar',\n    'preciso do pix',\n    'manda o pix',\n    'me envia o boleto',\n    'boleto',\n    'pix'\n  ];\n\n  const segundaViaSolicitada = frasesSegundaVia.some(frase => msg.includes(frase));\n\n  // O campo 'acao' vai separado, não altera o raw_output (mensagem para o cliente)\n  results.push({\n    json: {\n      raw_output: item.json.output, // mensagem original pro cliente sem acao\n      intencao: 'Financeiro',\n      acao: segundaViaSolicitada ? 'SEGUNDA_VIA_SOLICITADA' : 'NENHUMA_ACAO'\n    }\n  });\n}\n\nreturn results;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[3412,1500],"id":"192c3d28-4de9-4a72-bb86-77874411abe2","name":"Code2"},{"parameters":{"resource":"messages-api","instanceName":"rastreamento","remoteJid":"={{ $('Filtra Webhook').item.json.telefone }}","messageText":"=🚨 **ATENÇÃO - NOVA SOLICITAÇÃO FINANCEIRA!** 🚨\n\n👤 **Cliente:** {{ $('Filtra Webhook').item.json.pushName }}  \n📱 **Número:** {{ $('Filtra Webhook').item.json.telefone }}\n\n💳 O cliente solicitou **segunda via de boleto ou PIX**.\n\n✅ Favor gerar e encaminhar o pagamento o quanto antes!\n","options_message":{}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[4220,1500],"id":"c7e902ed-86ad-4fa0-a5b5-270c19ab89bd","name":"Evolution API2","credentials":{"evolutionApi":{"id":"FK5HLtfwZybZ0Kyw","name":"Evolution "}}},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[4008,1500],"id":"e3197c5a-f6af-447a-8bfc-bf246f018a6a","name":"Wait","webhookId":"0f5f6674-a9d1-4b54-a779-91f945377bb1"},{"parameters":{"assignments":{"assignments":[{"id":"702a462d-d3c5-407c-9e74-38f16df7694a","name":"output","value":"={{ $json.raw_output }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3710,1300],"id":"80549811-2661-4f94-bbe4-9d8f25fb6fbd","name":"Edit Fields"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e1d4d83f-446d-40ae-bf7c-63e3a5834871","leftValue":"={{ $json.acao }}","rightValue":"SEGUNDA_VIA_SOLICITADA","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3710,1500],"id":"147b6666-aa73-412d-8edd-13fc6c6d6cdc","name":"If1"},{"parameters":{"assignments":{"assignments":[{"id":"cb3ffc65-a01d-4e65-9e55-b8e40efef695","name":"api_key","value":"DCCB27B978B8-42D6-B27B-3CA7D3C448A5","type":"string"},{"id":"6b3bdc2c-cb91-4001-8887-63e4ad7f5a4a","name":"body.apikey","value":"={{ $json.body.apikey }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-860,600],"id":"81acf649-a1c7-477d-be86-4353357b25a8","name":"Chave API","notes":"Centraliza a API Key. Alterar somente aqui"},{"parameters":{"modelName":"models/gemini-2.0-flash-001","options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatGoogleGemini","typeVersion":1,"position":[1440,60],"id":"e5448110-2d2c-43df-8af4-8d572abe0f3d","name":"Google Gemini Chat Model","credentials":{"googlePalmApi":{"id":"tIhbGtIIM3DTCmSt","name":"Google Gemini(PaLM) Api account"}}},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.1,"position":[1160,-140],"id":"0e5f2d9e-11ab-4f84-bc03-4a00f6338db8","name":"When chat message received","webhookId":"2e657566-4d35-45ac-90f9-08d323f52158"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[1440,-140],"id":"26db9d5c-7d14-4147-be0c-c228c65e5f0d","name":"AI Agent1"}],"connections":{"edit1":{"main":[[{"node":"Filtra Webhook","type":"main","index":0}]]},"auth":{"main":[[{"node":"mensagem_tipo","type":"main","index":0}]]},"mensagem_tipo":{"main":[[{"node":"Convert audio","type":"main","index":0}],[{"node":"Pega a mensagem","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"Chave API","type":"main","index":0}]]},"Convert audio":{"main":[[{"node":"Transcreve Audio","type":"main","index":0}]]},"Transcreve Audio":{"main":[[{"node":"edit1","type":"main","index":0}]]},"Pega a mensagem":{"main":[[{"node":"Filtra Webhook","type":"main","index":0}]]},"Filtra Webhook":{"main":[[{"node":"Insert_banco","type":"main","index":0}]]},"Insert_banco":{"main":[[{"node":"Redis9","type":"main","index":0}]]},"AI Agent":{"main":[[{"node":"Redis SET","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Redis5","type":"main","index":0}],[{"node":"Redis6","type":"main","index":0}],[{"node":"Redis8","type":"main","index":0}],[{"node":"Redis7","type":"main","index":0}],[]]},"Code":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"Evolution API1","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}]]},"Redis":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"AI Financeiro":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Redis1":{"ai_memory":[[{"node":"AI Financeiro","type":"ai_memory","index":0}]]},"Redis2":{"ai_memory":[[{"node":"AI Comercial","type":"ai_memory","index":0}]]},"Redis3":{"ai_memory":[[{"node":"AI Sinistro","type":"ai_memory","index":0}]]},"AI Comercial":{"main":[[{"node":"Evolution API","type":"main","index":0}]]},"Redis4":{"ai_memory":[[{"node":"AI Suporte","type":"ai_memory","index":0}]]},"AI Sinistro":{"main":[[{"node":"Evolution API","type":"main","index":0}]]},"Redis SET":{"main":[[{"node":"Code","type":"main","index":0}]]},"Redis GET":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"Redis5":{"main":[[{"node":"AI Comercial","type":"main","index":0}]]},"Redis6":{"main":[[{"node":"AI Sinistro","type":"main","index":0}]]},"Redis8":{"main":[[{"node":"AI Suporte","type":"main","index":0}]]},"Redis7":{"main":[[{"node":"AI Financeiro","type":"main","index":0}]]},"AI Suporte":{"main":[[{"node":"Evolution API","type":"main","index":0}]]},"Redis9":{"main":[[{"node":"Redis GET","type":"main","index":0}]]},"OpenAI":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"OpenAI1":{"ai_languageModel":[[{"node":"AI Sinistro","type":"ai_languageModel","index":0}]]},"OpenAI2":{"ai_languageModel":[[{"node":"AI Suporte","type":"ai_languageModel","index":0}]]},"OpenAI3":{"ai_languageModel":[[{"node":"AI Comercial","type":"ai_languageModel","index":0}]]},"OpenAI4":{"ai_languageModel":[[{"node":"AI Financeiro","type":"ai_languageModel","index":0}]]},"Code2":{"main":[[{"node":"Edit Fields","type":"main","index":0},{"node":"If1","type":"main","index":0}]]},"Wait":{"main":[[{"node":"Evolution API2","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Evolution API","type":"main","index":0}]]},"If1":{"main":[[{"node":"Wait","type":"main","index":0}]]},"Chave API":{"main":[[{"node":"auth","type":"main","index":0}]]},"When chat message received":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Google Gemini Chat Model":{"ai_languageModel":[[{"node":"AI Agent1","type":"ai_languageModel","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{"Webhook":[{"json":{"headers":{"host":"n8n.ronnysenna.com.br","user-agent":"axios/1.7.9","content-length":"933","accept-encoding":"gzip, compress, deflate, br","content-type":"application/json","x-forwarded-for":"172.18.0.1","x-forwarded-host":"n8n.ronnysenna.com.br","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"6de3c9edb341","x-real-ip":"172.18.0.1"},"params":{},"query":{},"body":{"event":"messages.upsert","instance":"rastreamento","data":{"key":{"remoteJid":"558592525311@s.whatsapp.net","fromMe":false,"id":"3EB057B9EB695BF076C9C9"},"pushName":"Ronny Senna","status":"DELIVERY_ACK","message":{"conversation":"Olá boa tarde.","messageContextInfo":{"deviceListMetadata":{"senderKeyHash":"JJsmufMAdzH6iQ==","senderTimestamp":"1742659537","senderAccountType":"E2EE","receiverAccountType":"E2EE","recipientKeyHash":"qpOWeakIGzXmVQ==","recipientTimestamp":"1742809182"},"deviceListMetadataVersion":2,"messageSecret":"uuISbH8XWeiKVTw2P6pHky+C3Q7t4u00CJhjzpnnIKs="}},"messageType":"conversation","messageTimestamp":1742921911,"instanceId":"46620019-2aa3-44b9-a85f-8b0a92187cb1","source":"web"},"destination":"https://n8n.ronnysenna.com.br/webhook/agente","date_time":"2025-03-25T13:58:31.259Z","sender":"558540420510@s.whatsapp.net","server_url":"http://localhost:8080","apikey":"DCCB27B978B8-42D6-B27B-3CA7D3C448A5"},"webhookUrl":"https://n8n.ronnysenna.com.br/webhook/agente","executionMode":"production"}}]},"versionId":"ecd34720-96c3-4a47-8bf8-f40e45af9941","triggerCount":3,"tags":[{"createdAt":"2025-03-15T18:38:28.214Z","updatedAt":"2025-03-15T18:39:43.268Z","id":"i5cUpKKh0IeX9GoB","name":"IDEAL"}]}